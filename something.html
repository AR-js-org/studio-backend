<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Title</title>
        <script src="dist/arjs-studio-backend.js"></script>
    </head>
    <body>
        <label>
            Choose marker image
            <input id="marker-image" type="file">
        </label>


        <label>
            Choose AR asset
            <input id="ar-asset" type="file">
        </label>

        <button id="do-it">Generate package</button>

        <script>
            (async () => {
                const {
                    MarkerModule,
                    ASSET_3D,
                    Package,
                    AR_PATTERN
                } = ARjsStudioBackend;

                const markerInput = document.querySelector('#marker-image');
                const assetInput = document.querySelector('#ar-asset');
                const btn = document.querySelector('button#do-it');
                btn.addEventListener('click', async () => {
                    // convert input image to dataURL
                    const fr = new FileReader();
                    const waitRead = () => {
                        return new Promise(resolve => {
                            fr.addEventListener('load', () => {
                                resolve(fr.result);
                            });
                        })
                    };
                    fr.readAsDataURL(markerInput.files[0]);
                    const originalImage = await waitRead();
                    //console.log('IMAGE DATAURL', originalImage);

                    // generate full marker and patt file
                    const fullMarker = await MarkerModule.getFullMarkerImage(originalImage, 0.5, 512, 'black');
                    const markerPatt = await MarkerModule.getMarkerPattern(originalImage);

                    // show full marker and log patt file
                    const fullMarkerImage = new Image();
                    const waitLoad = () => {
                        return new Promise(resolve => {
                            fullMarkerImage.addEventListener('load', () => resolve());
                        })
                    };
                    fullMarkerImage.src = fullMarker;
                    await waitLoad();
                    document.body.appendChild(fullMarkerImage);
                    //console.log('PATT FILE', pattFile);

                    // get asset filename
                    const assetName = assetInput.files[0].name;
                    //console.log('ASSET FILENAME', assetName);

                    // get asset file content
                    fr.readAsText(assetInput.files[0]);
                    const assetFile = await waitRead();
                    //console.log('ASSET FILE', assetFile);

                    // init package
                    const packager = new Package({
                        arType: AR_PATTERN,
                        assetType: ASSET_3D,
                        assetFile,
                        assetName,
                        markerPatt
                    });

                    // generate zip file
                    const zipPackage = await packager.serve({
                        packageType: 'zip',
                        compression: 7
                    });
                    //console.log('ZIP PACKAGE', zipPackage);

                    // trigger zip download
                    const packageDownload = document.createElement('a');
                    packageDownload.href = `data:text/plain;base64,${zipPackage}`;
                    packageDownload.download = 'package.zip';
                    packageDownload.click();

                    // serve on github
                    const ghPackage = await packager.serve({
                        packageType: 'github',
                        token: '1243e72fa54a5c940b025394e5a44df47bd76741',
                    });
                    console.log('GITHUB LINK', ghPackage);
                });
            })();
        </script>
    </body>
</html>
